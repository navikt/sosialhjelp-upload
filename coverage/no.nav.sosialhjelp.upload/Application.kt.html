<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Application.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">upload</a> &gt; <a href="index.source.html" class="el_package">no.nav.sosialhjelp.upload</a> &gt; <span class="el_source">Application.kt</span></div><h1>Application.kt</h1><pre class="source lang-java linenums">package no.nav.sosialhjelp.upload

import io.ktor.server.application.*
import io.ktor.server.config.ApplicationConfig
import io.ktor.server.plugins.di.*
import no.ks.kryptering.CMSKrypteringImpl
import no.nav.sosialhjelp.upload.action.DownstreamUploadService
import no.nav.sosialhjelp.upload.action.fiks.FiksClient
import no.nav.sosialhjelp.upload.database.DocumentRepository
import no.nav.sosialhjelp.upload.database.UploadRepository
import no.nav.sosialhjelp.upload.database.notify.DocumentNotificationService
import no.nav.sosialhjelp.upload.fs.FileSystemStorage
import no.nav.sosialhjelp.upload.fs.GcpBucketStorage
import no.nav.sosialhjelp.upload.fs.Storage
import no.nav.sosialhjelp.upload.pdf.GotenbergService
import no.nav.sosialhjelp.upload.status.DocumentStatusService
import no.nav.sosialhjelp.upload.texas.TexasClient
import no.nav.sosialhjelp.upload.tusd.TusService
import no.nav.sosialhjelp.upload.validation.UploadValidator
import no.nav.sosialhjelp.upload.validation.VirusScanner
import org.flywaydb.core.Flyway
import org.jooq.DSLContext
import org.jooq.SQLDialect
import org.jooq.impl.DSL
import org.postgresql.ds.PGSimpleDataSource
import javax.sql.DataSource

fun main(args: Array&lt;String&gt;) {
    io.ktor.server.netty.EngineMain
        .main(args)
}

private fun getDataSource(config: ApplicationConfig): DataSource {
    val user = config.property(&quot;database.user&quot;).getString()
    val password = config.property(&quot;database.password&quot;).getString()
    val jdbcUrl = config.property(&quot;database.jdbcUrl&quot;).getString()
    return PGSimpleDataSource().apply {
        setUrl(jdbcUrl)
        setUser(user)
        setPassword(password)
    }
}

private fun migrateDatabase(dataSource: DataSource) {
    val load =
        Flyway
            .configure()
            .dataSource(dataSource)
            .locations(&quot;db/migration&quot;)
            .load()
    load.migrate()
}

fun Application.module() {
    val dataSource = getDataSource(environment.config)
    migrateDatabase(dataSource)
    dependencies {
        provide&lt;DataSource&gt; {
<span class="nc" id="L59">            dataSource</span>
        }
        provide&lt;DSLContext&gt; {
<span class="nc" id="L62">            DSL.using(dataSource, SQLDialect.POSTGRES)</span>
        }
<span class="nc" id="L64">        provide { this@module.environment.log }</span>
        provide&lt;Storage&gt; {
<span class="nc" id="L66">            val isLocal =</span>
<span class="nc" id="L67">                this@module</span>
<span class="nc" id="L68">                    .environment.config</span>
<span class="nc" id="L69">                    .property(&quot;runtimeEnv&quot;)</span>
<span class="nc" id="L70">                    .getString() == &quot;local&quot;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (isLocal) {</span>
<span class="nc" id="L72">                FileSystemStorage(</span>
<span class="nc" id="L73">                    this@module</span>
<span class="nc" id="L74">                        .environment.config</span>
<span class="nc" id="L75">                        .property(&quot;storage.basePath&quot;)</span>
<span class="nc" id="L76">                        .getString(),</span>
                )
            } else {
<span class="nc" id="L79">                GcpBucketStorage(</span>
<span class="nc" id="L80">                    this@module</span>
<span class="nc" id="L81">                        .environment.config</span>
<span class="nc" id="L82">                        .property(&quot;storage.bucketName&quot;)</span>
<span class="nc" id="L83">                        .getString(),</span>
<span class="nc" id="L84">                    this@module</span>
<span class="nc" id="L85">                        .environment.config</span>
<span class="nc" id="L86">                        .property(&quot;storage.gcsCredentials&quot;)</span>
<span class="nc" id="L87">                        .getString(),</span>
                )
<span class="nc" id="L89">            }</span>
        }
        provide(TexasClient::class)
        provide(CMSKrypteringImpl::class)
        provide(VirusScanner::class)
        provide(UploadValidator::class)
        provide(FiksClient::class)
        provide(TusService::class)
        provide(UploadRepository::class)
        provide(DocumentRepository::class)
        provide(DocumentStatusService::class)
        provide(GotenbergService::class)
        provide(DownstreamUploadService::class)
        provide(DocumentNotificationService::class)
    }
    configureSecurity()
    configureHTTP()
    configureMonitoring()
    configureStatusPages()
    configureRouting()
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>