<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadRepository.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">upload</a> &gt; <a href="index.source.html" class="el_package">no.nav.sosialhjelp.upload.database</a> &gt; <span class="el_source">UploadRepository.kt</span></div><h1>UploadRepository.kt</h1><pre class="source lang-java linenums">package no.nav.sosialhjelp.upload.database

import no.nav.sosialhjelp.upload.database.generated.tables.references.DOCUMENT
import no.nav.sosialhjelp.upload.database.generated.tables.references.ERROR
import no.nav.sosialhjelp.upload.database.generated.tables.references.UPLOAD
import no.nav.sosialhjelp.upload.database.notify.DocumentNotificationService
import no.nav.sosialhjelp.upload.validation.Validation
import no.nav.sosialhjelp.upload.validation.ValidationCode
import org.jooq.Configuration
import java.util.*

<span class="fc" id="L12">data class UploadWithFilename(</span>
<span class="fc" id="L13">    val id: UUID?,</span>
<span class="fc" id="L14">    val originalFilename: String?,</span>
<span class="fc" id="L15">    val convertedFilename: String?,</span>
<span class="fc" id="L16">    val errors: List&lt;ValidationCode&gt;,</span>
<span class="fc" id="L17">    val signedUrl: String?,</span>
<span class="pc" id="L18">    val fileSize: Long?</span>
)

<span class="fc" id="L21">class UploadRepository(</span>
<span class="pc" id="L22">    val notificationService: DocumentNotificationService,</span>
) {
    fun create(
        tx: Configuration,
        documentId: UUID,
        filename: String,
        filesize: Long,
    ): UUID? =
<span class="fc" id="L30">        tx</span>
<span class="fc" id="L31">            .dsl()</span>
<span class="fc" id="L32">            .insertInto(UPLOAD)</span>
<span class="fc" id="L33">            .set(UPLOAD.ID, UUID.randomUUID())</span>
<span class="fc" id="L34">            .set(UPLOAD.DOCUMENT_ID, documentId)</span>
<span class="fc" id="L35">            .set(UPLOAD.ORIGINAL_FILENAME, filename)</span>
<span class="fc" id="L36">            .set(UPLOAD.SIZE, filesize)</span>
<span class="fc" id="L37">            .returning(UPLOAD.ID)</span>
<span class="fc" id="L38">            .fetchOne()</span>
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">            ?.get(UPLOAD.ID)</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">            ?.also {</span>
<span class="fc" id="L41">                notifyChange(tx, it)</span>
<span class="fc" id="L42">            }</span>

    fun notifyChange(
        tx: Configuration,
        uploadId: UUID,
<span class="fc" id="L47">    ) = notificationService.notifyUpdate(getDocumentIdFromUploadId(tx, uploadId)!!)</span>

    fun isOwnedByUser(
        tx: Configuration,
        uploadId: UUID,
        ownerIdent: String,
    ): Boolean =
<span class="fc bfc" id="L54" title="All 2 branches covered.">        tx</span>
<span class="fc" id="L55">            .dsl()</span>
<span class="fc" id="L56">            .selectCount()</span>
<span class="fc" id="L57">            .from(UPLOAD)</span>
<span class="fc" id="L58">            .join(DOCUMENT)</span>
<span class="fc" id="L59">            .on(DOCUMENT.ID.eq(UPLOAD.DOCUMENT_ID))</span>
<span class="fc" id="L60">            .where(UPLOAD.ID.eq(uploadId))</span>
<span class="fc" id="L61">            .and(DOCUMENT.OWNER_IDENT.eq(ownerIdent))</span>
<span class="fc" id="L62">            .fetchSingle()</span>
<span class="fc" id="L63">            .value1() &gt; 0</span>

    fun getDocumentIdFromUploadId(
        tx: Configuration,
        uploadId: UUID,
    ): UUID? =
<span class="fc" id="L69">        tx</span>
<span class="fc" id="L70">            .dsl()</span>
<span class="fc" id="L71">            .select(UPLOAD.DOCUMENT_ID)</span>
<span class="fc" id="L72">            .from(UPLOAD)</span>
<span class="fc" id="L73">            .where(UPLOAD.ID.eq(uploadId))</span>
<span class="fc" id="L74">            .fetchOne()</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            ?.get(UPLOAD.DOCUMENT_ID)</span>

    fun getUploadsWithFilenames(
        tx: Configuration,
        documentId: UUID,
    ): List&lt;UploadWithFilename&gt; =
<span class="fc" id="L81">        tx</span>
<span class="fc" id="L82">            .dsl()</span>
<span class="fc" id="L83">            .select(UPLOAD.ID, UPLOAD.ORIGINAL_FILENAME, UPLOAD.CONVERTED_FILENAME, ERROR.CODE, UPLOAD.SIGNED_URL, UPLOAD.SIZE)</span>
<span class="fc" id="L84">            .from(UPLOAD)</span>
<span class="fc" id="L85">            .leftJoin(ERROR)</span>
<span class="fc" id="L86">            .on(ERROR.UPLOAD.eq(UPLOAD.ID))</span>
<span class="fc" id="L87">            .where(UPLOAD.DOCUMENT_ID.eq(documentId))</span>
<span class="fc" id="L88">            .fetch()</span>
<span class="fc" id="L89">            .groupBy { it.get(UPLOAD.ID) }</span>
<span class="fc" id="L90">            .map { (id, records) -&gt;</span>
<span class="fc" id="L91">                UploadWithFilename(</span>
<span class="fc" id="L92">                    id = id,</span>
<span class="fc" id="L93">                    originalFilename = records.first().get(UPLOAD.ORIGINAL_FILENAME),</span>
<span class="fc" id="L94">                    convertedFilename = records.first().get(UPLOAD.CONVERTED_FILENAME),</span>
<span class="pc" id="L95">                    errors = records.mapNotNull { it.get(ERROR.CODE) }.map { ValidationCode.valueOf(it) },</span>
<span class="fc" id="L96">                    signedUrl = records.first().get(UPLOAD.SIGNED_URL),</span>
<span class="fc" id="L97">                    fileSize = records.first().get(UPLOAD.SIZE),</span>
<span class="fc" id="L98">                )</span>
<span class="fc" id="L99">            }</span>

    fun updateConvertedFilename(
        tx: Configuration,
        name: String,
        uploadId: UUID,
    ) {
<span class="fc" id="L106">        tx</span>
<span class="fc" id="L107">            .dsl()</span>
<span class="fc" id="L108">            .update(UPLOAD)</span>
<span class="fc" id="L109">            .set(UPLOAD.CONVERTED_FILENAME, name)</span>
<span class="fc" id="L110">            .where(UPLOAD.ID.eq(uploadId))</span>
<span class="fc" id="L111">            .execute()</span>
<span class="fc" id="L112">    }</span>

    fun deleteUpload(
        tx: Configuration,
        uploadId: UUID,
    ): Int {
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        val documentId = getDocumentIdFromUploadId(tx, uploadId) ?: error(&quot;No documentid for upload&quot;)</span>
<span class="fc" id="L119">        val deleted =</span>
<span class="fc" id="L120">            tx</span>
<span class="fc" id="L121">                .dsl()</span>
<span class="fc" id="L122">                .delete(UPLOAD)</span>
<span class="fc" id="L123">                .where(UPLOAD.ID.eq(uploadId))</span>
<span class="fc" id="L124">                .execute()</span>
<span class="fc" id="L125">        notificationService.notifyUpdate(documentId)</span>
<span class="fc" id="L126">        return deleted</span>
    }

    fun addErrors(
        tx: Configuration,
        uploadId: UUID,
        validations: List&lt;Validation&gt;,
    ) {
<span class="fc" id="L134">        validations</span>
<span class="fc" id="L135">            .forEach {</span>
<span class="fc" id="L136">                tx</span>
<span class="fc" id="L137">                    .dsl()</span>
<span class="fc" id="L138">                    .insertInto(ERROR)</span>
<span class="fc" id="L139">                    .set(ERROR.UPLOAD, uploadId)</span>
<span class="fc" id="L140">                    .set(ERROR.CODE, it.code.name)</span>
<span class="fc" id="L141">                    .set(ERROR.ID, UUID.randomUUID())</span>
<span class="fc" id="L142">                    .execute()</span>
<span class="fc" id="L143">            }.also { notifyChange(tx, uploadId) }</span>
<span class="fc" id="L144">    }</span>

    fun setSignedUrl(
        tx: Configuration,
        url: String,
        id: UUID,
    ) {
<span class="fc" id="L151">        tx</span>
<span class="fc" id="L152">            .dsl()</span>
<span class="fc" id="L153">            .update(UPLOAD)</span>
<span class="fc" id="L154">            .set(UPLOAD.SIGNED_URL, url)</span>
<span class="fc" id="L155">            .where(UPLOAD.ID.eq(id))</span>
<span class="fc" id="L156">            .execute()</span>
<span class="fc" id="L157">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>